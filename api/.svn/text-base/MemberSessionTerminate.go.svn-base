package api

import (
	"encoding/json"
	"fmt"
	"github.com/user/apiserver/app"
	"net/http"
	"strings"
)

func MemberSessionTerminate(r *http.Request) (int, []byte) {

	type Output struct {
		sessionID string
		status    string
	}
	var o Output

	//----------------------------------------------------------
	// get the sessionID from the URL
	//----------------------------------------------------------
	tmp := strings.Split(strings.TrimRight(r.URL.Path[1:], "/"), "/")
	if len(tmp) != 2 {
		app.Error(fmt.Sprintf("MemberSessionGet() - INVALID_INPUT_FORMAT"))
		e := make(map[string]string)
		e["ERROR"] = "INVALID_INPUT_FORMAT"
		b, _ := json.Marshal(e)
		return 404, b
	}
	sessionID := tmp[1]
	app.Debug("received logoff request for sessionID[" + sessionID + "]")

	//----------------------------------------------------------
	// run the query to update the session in the database
	//----------------------------------------------------------
	sql := "UPDATE MEMBER_SESSION SET logoffTime = now() WHERE sessionID = ? AND logoffTime IS NULL"
	app.Debug(sql)
	result, err := app.Db.Exec(sql, sessionID)
	if err != nil {
		panic(err)
	}
	app.Debug(fmt.Sprintf("SQL RESULT: %v", result))

	//---------------------------------------------------
	// convert the output type into json and return it
	//---------------------------------------------------
	x := make(map[string]Output)
	x["MemberSession"] = o

	output, err := json.Marshal(x)
	if err != nil {
		panic(err)
	}

	// app.Info(fmt.Sprintf("terminated session for sessionID[%s]", sessionID))
	return 0, output
}
